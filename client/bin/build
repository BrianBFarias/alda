#!/usr/bin/env bash

set -e

cd "$(dirname "$0")/../"

mkdir -p target

# Keep the target folder from getting too big by deleting any builds older than
# 7 days.
if [ -d target/ ]; then
  find \
    target/ \
    -maxdepth 1 \
    -not -path target/ \
    -type d \
    -mtime +7 \
    -exec rm -vrf {} \;
fi

# See comments about generated code in main.go.
go generate

build_sha="$(../bin/current-content-sha client)"

if [[ -d "target/$build_sha" ]]; then
  echo "Existing build: $PWD/target/$build_sha"
  exit 0
fi

# Refuse to build unless the tests are all passing.
go test $(go list ./...)

function build() {
  os="$1"
  arch="$2"
  arm="$3"

  if [[ -n "$arm" ]]; then
    arm_ext="-$3"
  else
    arm_ext=""
  fi

  if [[ "$os" == "windows" ]]; then
    ext=".exe"
  else
    ext=""
  fi

  output_filename="target/$build_sha/$os-$arch$arm_ext/alda$ext"

  echo "Building $output_filename..."

  # Install the standard packages locally to speed up subsequent builds.
  GOOS="$os" GOARCH="$arch" GOARM="$arm" go install

  # Build.
  #
  # Notes:
  # * The trimpath flags make it so that paths are stripped in the binary, which
  #   we need because otherwise, the full path to the executable (at build time!
  #   like, it contains "/home/circleci"!) ends up in the log output.
  #   Reference: https://github.com/rs/zerolog/issues/133#issuecomment-464404901
  CGO_ENABLED=0 GOOS="$os" GOARCH="$arch" GOARM="$arm" \
    go build \
    -tags netgo \
    -ldflags '-w -extldflags "-static"' \
    -gcflags="all=-trimpath=$PWD" \
    -asmflags="all=-trimpath=$PWD" \
    -o "$output_filename" \
    main.go
}

for os in windows darwin linux; do
  for arch in 386 amd64; do
    # Support for darwin/386 was apparently removed around Go 1.13.
    if [[ "$os" == darwin ]] && [[ "$arch" == 386 ]]; then
      continue
    fi

    build $os $arch
  done
done

# ARM build, with a specific goal of supporting Raspberry Pi
#
# Reference:
# https://zchee.github.io/golang-wiki/GoArm/
# https://www.thepolyglotdeveloper.com/2017/04/cross-compiling-golang-applications-raspberry-pi/
build linux arm 7  # a.k.a. ARM 7
build linux arm64  # a.k.a. ARM 8 (GOARM env var no longer needed)

echo "Done."

